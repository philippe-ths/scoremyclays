---
description: "AI agent constraints and guidance for test automation in ScoreMyClays PWA development"
alwaysApply: true
---

# Test Automation Constraints for AI Agents

## IMPERATIVE: Testing Tool Restrictions

### Required Testing Stack
- **Unit Testing**: ONLY Vitest - never Jest, Mocha, or alternatives
- **Component Testing**: ONLY React Testing Library + Vitest Browser Mode
- **E2E Testing**: ONLY Playwright - never Cypress, Selenium, or alternatives
- **Visual Testing**: ONLY BrowserBase + Stagehand when visual regression needed

### Forbidden Testing Approaches
- **NO Jest configuration**: Use Vitest exclusively for unit testing
- **NO Cypress**: Use Playwright for all E2E and integration testing
- **NO manual browser testing**: Automate with Playwright
- **NO snapshot testing**: Use visual regression with BrowserBase + Stagehand instead

## Test File Organization Requirements

### Directory Structure (MANDATORY)
```
app/src/__tests__/          # Unit and component tests
├── components/             # Component-specific tests
│   ├── scoring/           # Scoring component tests
│   └── layout/            # Layout component tests
├── lib/                   # Utility function tests
├── context/               # React context tests
└── setup.ts               # Test configuration

app/tests/                  # E2E and integration tests
├── scoring/               # Scoring workflow tests
├── pwa/                   # PWA feature tests
├── offline.spec.ts        # Offline functionality
└── performance/           # Performance tests
```

### File Naming Conventions
- **Unit Tests**: `*.test.ts` or `*.test.tsx`
- **E2E Tests**: `*.spec.ts`
- **Test Utilities**: `test-utils.tsx`, `setup.ts`
- **Mock Files**: `__mocks__/[module-name].ts`

## Clay Shooting Domain Test Requirements

### Business Logic Testing Priority
1. **Scoring Calculations**: calculateSessionScore, calculatePositionScore, calculatePercentage
2. **Session Management**: createSession, updateSession, deleteSession
3. **Data Validation**: input sanitization, boundary condition handling
4. **Competition Rules**: Trap/Skeet/Sporting Clays specific logic

### PWA-Specific Testing Requirements
- **Service Worker**: Registration, activation, cache strategies
- **Offline Functionality**: Data persistence, sync on reconnection
- **Installation**: PWA manifest, installation prompts
- **Performance**: Core Web Vitals, touch responsiveness

## Test Data Management Constraints

### Required Test Scenarios
```typescript
// MANDATORY clay shooting test data patterns
const REQUIRED_TEST_SCENARIOS = {
  perfectRound: Array(25).fill({ result: 'hit' }),
  mixedRound: [
    { result: 'hit' }, { result: 'miss' }, { result: 'no-bird' },
    { result: 'hit' }, { result: 'hit' }
  ],
  emptySession: { positions: [], totalScore: 0 },
  corruptedData: '{"invalid": json}'
}
```

### Data Integrity Testing
- **Concurrent Operations**: Test simultaneous scoring actions
- **Storage Limits**: Test localStorage quota handling
- **Data Recovery**: Test corruption recovery mechanisms
- **Sync Conflicts**: Test offline/online data conflicts

## Performance Testing Constraints

### Core Web Vitals Thresholds (NON-NEGOTIABLE)
```typescript
// MANDATORY performance thresholds
const PERFORMANCE_REQUIREMENTS = {
  LCP: 2500,  // Largest Contentful Paint < 2.5s
  INP: 200,   // Interaction to Next Paint < 200ms
  CLS: 0.1,   // Cumulative Layout Shift < 0.1
  FCP: 1800   // First Contentful Paint < 1.8s
}
```

### Clay Shooting Performance Requirements
- **Scoring Input Response**: <100ms for hit/miss/no-bird
- **Touch Target Response**: <50ms for button interactions
- **Position Navigation**: <200ms for advancing positions
- **Session Loading**: <1s for historical session retrieval

## Test Implementation Constraints

### Unit Test Requirements
- **Coverage Minimum**: 80% all metrics, 90% business logic
- **Mock Strategy**: External dependencies only (APIs, localStorage, serviceWorker)
- **Test Isolation**: Each test must be independent and idempotent
- **Async Handling**: Proper await/async patterns for all asynchronous operations

### Component Test Requirements
- **Accessibility**: Use `screen.getByRole()` for element queries
- **User Interactions**: Use `@testing-library/user-event` for all interactions
- **State Testing**: Focus on component behavior, not implementation
- **Error Boundaries**: Test error states and recovery

### E2E Test Requirements
- **Cross-Browser**: Test Chrome, Firefox, Safari (latest 2 versions)
- **Mobile Devices**: Test iOS Safari, Android Chrome
- **Offline Testing**: Use `page.context().setOffline(true)`
- **Real Network**: Test on slow networks, not just fast connections

## AI Agent Testing Responsibilities

### MUST Generate Tests For
- **New scoring calculations**: Any mathematical operations
- **User interaction flows**: Button clicks, form submissions, navigation
- **Data persistence**: localStorage operations, session management
- **PWA features**: Service worker, offline functionality, installation

### MUST NOT Generate Tests For
- **Implementation details**: Internal component state, private methods
- **Third-party libraries**: Testing library behavior itself
- **Visual styling**: CSS properties, layout details (use visual regression instead)
- **Network requests**: Test mocks, not actual API calls

## Error Handling Test Requirements

### Clay Shooting Error Scenarios
```typescript
// MANDATORY error handling test cases
const REQUIRED_ERROR_TESTS = [
  'Invalid scoring input (non hit/miss/no-bird)',
  'Session data corruption recovery',
  'Network disconnection during scoring',
  'localStorage quota exceeded',
  'Service worker registration failure',
  'Rapid input causing race conditions'
]
```

### Accessibility Error Testing
- **High contrast mode**: Outdoor visibility simulation
- **Touch target size**: Minimum 44x44px validation
- **Screen reader**: ARIA label and description testing
- **Keyboard navigation**: Full functionality without mouse/touch

## Quality Gates (NON-NEGOTIABLE)

### Pre-Commit Requirements
- **All unit tests pass**: Zero failures allowed
- **Coverage thresholds met**: 80%+ for all metrics
- **E2E critical paths pass**: 100% success rate
- **Performance requirements met**: All Core Web Vitals in "Good" range

### CI/CD Pipeline Requirements
- **Cross-browser testing**: All supported browsers pass
- **Mobile device testing**: iOS and Android compatibility
- **Accessibility validation**: Zero WCAG 2.1 AA violations
- **Performance regression**: <5% degradation tolerance

## Test Maintenance Constraints

### Self-Healing Test Requirements
- Use `data-testid` attributes for stable element selection
- Implement retry logic for network-dependent tests
- Use AI-powered selector adaptation when possible
- Maintain test relevance through quarterly reviews

### Documentation Requirements
- Document test purpose and clay shooting context
- Include performance benchmarks and expectations
- Maintain test data examples and scenarios
- Update tests when business rules change

These constraints ensure AI agents generate consistent, high-quality tests that validate ScoreMyClays PWA functionality while maintaining development velocity and clay shooting domain accuracy.
