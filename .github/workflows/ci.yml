name: CI/CD Pipeline

on:
  push:
    branches: ['main', 'develop', 'feature/**', 'bugfix/**', 'hotfix/**']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Quality Assurance Job
  quality-check:
    name: üîç Quality Assurance
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚ö° Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci --prefer-offline --no-audit

      - name: üîç Type checking
        working-directory: ./app
        run: npm run type-check

      - name: üé® Check formatting
        working-directory: ./app
        run: npm run format:check

      - name: üö® ESLint analysis
        working-directory: ./app
        run: npm run lint

      - name: üîí Security audit
        working-directory: ./app
        run: npm audit --audit-level=high
        continue-on-error: true

  # Build Job
  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ‚ö° Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci --prefer-offline --no-audit

      - name: üî® Build application
        working-directory: ./app
        run: npm run build
        env:
          NODE_ENV: production

      - name: üìä Bundle analysis
        working-directory: ./app
        run: |
          # Check bundle size and report
          echo "üì¶ Build completed successfully!"
          echo "üîç Build output size:"
          du -sh .next/ 2>/dev/null || echo "Build directory not found"

      - name: üíæ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
                    .next
        public
          retention-days: 7

  # PWA Validation Job
  pwa-validation:
    name: üì± PWA Validation
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ‚ö° Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üíæ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci --prefer-offline --no-audit

      - name: üîç PWA Manifest validation
        working-directory: ./app
        run: |
          echo "üîç Validating PWA manifest..."
          if [ -f "public/manifest.json" ]; then
            echo "‚úÖ Manifest file exists"
            # Basic JSON validation
            if jq empty public/manifest.json; then
              echo "‚úÖ Manifest is valid JSON"
            else
              echo "‚ùå Manifest JSON is invalid"
              exit 1
            fi
          else
            echo "‚ùå Manifest file not found"
            exit 1
          fi

      - name: üîç Service Worker validation
        working-directory: ./app
        run: |
          echo "üîç Checking for Service Worker..."
          if [ -f "public/sw.js" ]; then
            echo "‚úÖ Service Worker found"
          else
            echo "‚ö†Ô∏è  Service Worker not found (this is OK for development)"
          fi

  # Clay Shooting Specific Tests
  clay-shooting-tests:
    name: üéØ Clay Shooting Context Tests
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ‚ö° Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci --prefer-offline --no-audit

      - name: üéØ Clay shooting domain validation
        working-directory: ./app
        run: |
          echo "üéØ Validating clay shooting specific features..."
          
          # Check for scoring components
          if find src -name "*scoring*" -type f | grep -q .; then
            echo "‚úÖ Scoring components found"
          else
            echo "‚ö†Ô∏è  No scoring components found"
          fi
          
          # Check for PWA manifest clay shooting metadata
          if grep -q "clay\|shooting\|trap\|skeet" public/manifest.json 2>/dev/null; then
            echo "‚úÖ Clay shooting context found in manifest"
          else
            echo "‚ö†Ô∏è  Clay shooting context not found in manifest"
          fi
          
          # Check for mobile-optimized components
          if find src -name "*mobile*" -o -name "*touch*" -type f | grep -q .; then
            echo "‚úÖ Mobile-optimized components found"
          else
            echo "‚ö†Ô∏è  Consider adding mobile-specific components"
          fi

  # Performance Tests
  performance:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ‚ö° Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üíæ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci --prefer-offline --no-audit

      - name: üöÄ Start application
        working-directory: ./app
        run: |
          npm start &
          sleep 10
          # Basic health check
          curl -f http://localhost:3000 || exit 1
        timeout-minutes: 2

      - name: ‚ö° Performance check
        working-directory: ./app
        run: |
          echo "‚ö° Basic performance validation complete"
          echo "üìä Consider adding Lighthouse CI for detailed performance metrics"

  # Summary Job
  ci-summary:
    name: üìã CI Summary
    runs-on: ubuntu-latest
    needs: [quality-check, build, pwa-validation, clay-shooting-tests]
    if: always()
    
    steps:
      - name: üìã Summary Report
        run: |
          echo "## üéØ ScoreMyClays CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Completed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Assurance: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Application: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PWA Validation: ${{ needs.pwa-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Clay Shooting Tests: ${{ needs.clay-shooting-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Review any failed checks above" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure all clay shooting specific validations pass" >> $GITHUB_STEP_SUMMARY
          echo "- Consider deploying to Vercel for staging environment" >> $GITHUB_STEP_SUMMARY
          
          # Check if any critical jobs failed
          if [[ "${{ needs.quality-check.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "‚ùå Critical jobs failed - deployment should not proceed"
            exit 1
          else
            echo "‚úÖ All critical jobs passed - ready for deployment"
          fi